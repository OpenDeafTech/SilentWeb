name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release tag (e.g. v1.2.3)"
        required: true
      channel:
        description: "Firefox Add-ons channel"
        required: false
        default: "listed"
        type: choice
        options:
          - listed
          - unlisted
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  PNPM_VERSION: 9.12.0

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
      AMO_API_KEY: ${{ secrets.AMO_API_KEY }}
      AMO_API_SECRET: ${{ secrets.AMO_API_SECRET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine release tag
        id: release-tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.version }}"
            if [ -z "$TAG" ]; then
              echo "Missing workflow_dispatch input 'version'." >&2
              exit 1
            fi
          else
            TAG="${GITHUB_REF_NAME}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Determine release channel
        id: release-channel
        run: |
          CHANNEL="${{ github.event.inputs.channel }}"
          if [ -z "$CHANNEL" ]; then
            CHANNEL="listed"
          fi
          echo "channel=$CHANNEL" >> "$GITHUB_OUTPUT"

      - name: Ensure AMO credentials are set
        run: |
          if [ -z "$AMO_API_KEY" ] || [ -z "$AMO_API_SECRET" ]; then
            echo "AMO_API_KEY and AMO_API_SECRET must be set as repository secrets." >&2
            exit 1
          fi

      - name: Create and push tag (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          TAG="${{ steps.release-tag.outputs.tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists." >&2
            exit 1
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$TAG"
          git push origin "$TAG"

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          package_json_file: package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run release bundle
        run: pnpm run release

      - name: Sign extension with AMO
        run: |
          pnpm exec web-ext sign \
            --config web-ext.config.js \
            --channel ${{ steps.release-channel.outputs.channel }} \
            --api-key "$AMO_API_KEY" \
            --api-secret "$AMO_API_SECRET"

      - name: Collect signed artifact
        id: signed-artifact
        run: |
          SIGNED_XPI=$(find web-ext-artifacts -maxdepth 1 -name '*.xpi' -type f -print | head -n 1)
          if [ -z "$SIGNED_XPI" ]; then
            echo "No signed .xpi artifact found." >&2
            exit 1
          fi
          echo "file=$SIGNED_XPI" >> "$GITHUB_OUTPUT"

      - name: Upload signed artifact
        uses: actions/upload-artifact@v4
        with:
          name: signed-xpi
          path: ${{ steps.signed-artifact.outputs.file }}
          if-no-files-found: error

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-tag.outputs.tag }}
          name: SilentWeb ${{ steps.release-tag.outputs.tag }}
          files: ${{ steps.signed-artifact.outputs.file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
